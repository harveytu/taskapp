#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
});

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

async function setupFirebase() {
  console.log('ğŸ”¥ Firebase & Firestore Setup\n');
  console.log('This script will help you configure your existing Firebase project.\n');
  console.log('ğŸ“ Where to find your Firebase config:');
  console.log('   1. Go to https://console.firebase.google.com/');
  console.log('   2. Select your project');
  console.log('   3. Click the âš™ï¸ gear icon â†’ "Project settings"');
  console.log('   4. Scroll to "Your apps" section');
  console.log('   5. Click the web app (</>) or create one if needed');
  console.log('   6. Copy values from the firebaseConfig object\n');
  console.log('   ğŸ’¡ See FIND_FIREBASE_CONFIG.md for detailed instructions\n');

  const config = {};

  config.projectId = await question('Enter your Firebase Project ID: ');
  console.log('\nğŸ’¡ The API Key is the "apiKey" value in your firebaseConfig');
  console.log('   It usually starts with "AIza..."\n');
  config.apiKey = await question('Enter your Firebase API Key: ');
  config.authDomain = await question('Enter your Auth Domain (or press Enter for default): ') || 
                      `${config.projectId}.firebaseapp.com`;
  config.storageBucket = await question('Enter your Storage Bucket (or press Enter for default): ') || 
                         `${config.projectId}.appspot.com`;
  config.messagingSenderId = await question('Enter your Messaging Sender ID: ');
  config.appId = await question('Enter your App ID: ');

  // Create .env.local file
  const envPath = path.join(__dirname, '..', '.env.local');
  const envContent = `# Firebase Configuration
# Generated by setup-firebase.js

NEXT_PUBLIC_FIREBASE_PROJECT_ID=${config.projectId}
NEXT_PUBLIC_FIREBASE_API_KEY=${config.apiKey}
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${config.authDomain}
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${config.storageBucket}
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${config.messagingSenderId}
NEXT_PUBLIC_FIREBASE_APP_ID=${config.appId}
`;

  fs.writeFileSync(envPath, envContent);
  console.log('\nâœ… Created .env.local file with your Firebase configuration!\n');

  // Test connection (optional)
  console.log('ğŸ§ª Testing Firebase connection...');
  try {
    // Check if firebase is installed
    require.resolve('firebase/app');
    const { initializeApp } = require('firebase/app');
    
    const firebaseApp = initializeApp({
      projectId: config.projectId,
      apiKey: config.apiKey,
      authDomain: config.authDomain,
      storageBucket: config.storageBucket,
      messagingSenderId: config.messagingSenderId,
      appId: config.appId,
    });

    console.log('âœ… Firebase configuration validated!\n');
  } catch (error) {
    if (error.code === 'MODULE_NOT_FOUND') {
      console.log('âš ï¸  Firebase package not found - run "npm install" first');
    } else {
      console.log('âš ï¸  Could not validate connection (this is okay)');
      console.log('   Error:', error.message);
    }
  }

  console.log('ğŸ“‹ Next steps:');
  console.log('1. Set up Firestore Security Rules (see firestore.rules)');
  console.log('2. Create Firestore indexes (see FIREBASE_SETUP.md)');
  console.log('3. Run "npm run dev" to start the development server\n');

  rl.close();
}

setupFirebase().catch((error) => {
  console.error('âŒ Setup failed:', error);
  rl.close();
  process.exit(1);
});

